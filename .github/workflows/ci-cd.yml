name: CI/CD â†’ Push images to ACR (API + stack)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  # Azure / ACR values (set these as repository secrets where appropriate)
  AZURE_ACR_LOGIN_SERVER: ${{ secrets.AZURE_ACR_LOGIN_SERVER }}
  AZURE_ACR_USERNAME: ${{ secrets.AZURE_ACR_USERNAME }}
  AZURE_ACR_PASSWORD: ${{ secrets.AZURE_ACR_PASSWORD }}

jobs:
  lint:
    name: Lint (flake8)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install flake8
        run: python -m pip install --upgrade pip && pip install flake8

      - name: Run flake8
        run: flake8 .

  test:
    name: Tests (pytest)
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run tests
        run: pytest -v

  build-and-push:
    name: Build & push images to ACR
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to ACR (Docker)
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.AZURE_ACR_LOGIN_SERVER }}
          username: ${{ env.AZURE_ACR_USERNAME }}
          password: ${{ env.AZURE_ACR_PASSWORD }}

      - name: Configure variables
        run: |
          echo "ACR=${AZURE_ACR_LOGIN_SERVER}" >> $GITHUB_ENV
          echo "SHA=${GITHUB_SHA}" >> $GITHUB_ENV

      # -----------------------------
      # Build & push your API image
      # -----------------------------
      - name: Build API image (from root Dockerfile)
        run: |
          set -e
          IMAGE="$ACR/api:${SHA}"
          LATEST="$ACR/api:latest"
          echo "Building $IMAGE"
          docker build --pull -t "$IMAGE" .
          docker tag "$IMAGE" "$LATEST"
          docker push "$IMAGE"
          docker push "$LATEST"
          echo "Pushed: $IMAGE and $LATEST"

      # -----------------------------
      # Pull third-party images, retag to ACR & push
      # -----------------------------
      - name: Retag & push prom/prometheus
        run: |
          set -e
          SRC=prom/prometheus:latest
          IMAGE="$ACR/prometheus:${SHA}"
          LATEST="$ACR/prometheus:latest"
          docker pull "$SRC"
          docker tag "$SRC" "$IMAGE"
          docker tag "$SRC" "$LATEST"
          docker push "$IMAGE"
          docker push "$LATEST"
          echo "Pushed prometheus -> $IMAGE, $LATEST"

      - name: Retag & push grafana/grafana
        run: |
          set -e
          SRC=grafana/grafana:main-ubuntu
          IMAGE="$ACR/grafana:${SHA}"
          LATEST="$ACR/grafana:latest"
          docker pull "$SRC"
          docker tag "$SRC" "$IMAGE"
          docker tag "$SRC" "$LATEST"
          docker push "$IMAGE"
          docker push "$LATEST"
          echo "Pushed grafana -> $IMAGE, $LATEST"

      - name: Retag & push mlflow (ghcr)
        run: |
          set -e
          SRC=ghcr.io/mlflow/mlflow:latest
          IMAGE="$ACR/mlflow:${SHA}"
          LATEST="$ACR/mlflow:latest"
          docker pull "$SRC"
          docker tag "$SRC" "$IMAGE"
          docker tag "$SRC" "$LATEST"
          docker push "$IMAGE"
          docker push "$LATEST"
          echo "Pushed mlflow -> $IMAGE, $LATEST"

      - name: Retag & push evidently service (docker hub)
        run: |
          set -e
          SRC=evidently/evidently-service:latest
          IMAGE="$ACR/evidently:${SHA}"
          LATEST="$ACR/evidently:latest"
          docker pull "$SRC"
          docker tag "$SRC" "$IMAGE"
          docker tag "$SRC" "$LATEST"
          docker push "$IMAGE"
          docker push "$LATEST"
          echo "Pushed evidently -> $IMAGE, $LATEST"

      - name: Retag & push nginx (report server)
        run: |
          set -e
          SRC=nginx:alpine
          IMAGE="$ACR/evidently-report-server:${SHA}"
          LATEST="$ACR/evidently-report-server:latest"
          docker pull "$SRC"
          docker tag "$SRC" "$IMAGE"
          docker tag "$SRC" "$LATEST"
          docker push "$IMAGE"
          docker push "$LATEST"
          echo "Pushed nginx -> $IMAGE, $LATEST"

      - name: Summary of pushed images
        run: |
          echo "Images pushed to ACR:"
          echo "- $ACR/api:latest and $ACR/api:${SHA}"
          echo "- $ACR/prometheus:latest and $ACR/prometheus:${SHA}"
          echo "- $ACR/grafana:latest and $ACR/grafana:${SHA}"
          echo "- $ACR/mlflow:latest and $ACR/mlflow:${SHA}"
          echo "- $ACR/evidently:latest and $ACR/evidently:${SHA}"
          echo "- $ACR/evidently-report-server:latest and $ACR/evidently-report-server:${SHA}"

      - name: Logout Docker
        run: docker logout ${{ env.AZURE_ACR_LOGIN_SERVER }}
